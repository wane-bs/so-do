<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S∆° ƒë·ªì H·ªá th·ªëng VinaLib-Vault v3.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            color: #2980b9;
            margin-top: 40px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }

        .diagram-container {
            background: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .mermaid {
            text-align: center;
            margin-top: 20px;
        }

        .description {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <h1>S∆° ƒë·ªì H·ªá th·ªëng VinaLib-Vault v3.0</h1>
    <p style="text-align: center;">T√†i li·ªáu visual h√≥a c·∫•u tr√∫c h·ªá th·ªëng m√¥ ph·ªèng (Mock Architecture) cho VinaLib-Vault
        (C·∫≠p nh·∫≠t 2026-02-19).</p>

    <!-- 1. Architecture -->
    <div class="diagram-container">
        <h2>1. Ki·∫øn tr√∫c t·ªïng quan (Architecture Overview)</h2>
        <p class="description">M√¥ h√¨nh chi·∫øn l∆∞·ª£c lai (Hybrid Strategy) v·ªõi Blockchain Core l√†m trung t√¢m.</p>
        <div class="mermaid">
            graph LR
            %% Define Styles
            classDef frontend fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
            classDef backend fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
            classDef blockchain fill:#fff3e0,stroke:#e65100,stroke-width:2px;
            classDef external fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,stroke-dasharray: 5 5;

            subgraph Web_Interaction ["L·ªõp Web3 DApp"]
            direction TB
            Frontend["Frontend React SDK<br />Web3Provider / ethers.js"]:::frontend
            end

            subgraph Blockchain_Core ["L·ªõp Blockchain C·ªët L√µi (Hardhat Local)"]
            direction TB
            Contracts["Smart Contracts (EVM)<br />(VinaLibVault, BookAsset)"]:::blockchain
            IPFS["IPFS Simulator<br />H√¨nh ·∫£nh & Metadata"]:::blockchain
            end

            subgraph Third_Party ["D·ªãch V·ª• B√™n Th·ª© 3"]
            direction TB
            Mocks["Mock API<br />T·∫°m ng∆∞ng / Legacy"]:::external
            end

            %% Flows
            Frontend -- "Giao d·ªãch MetaMask (Write) / RPC (Read)" --> Contracts
            Frontend -- "L∆∞u/ƒê·ªçc ·∫£nh b·∫±ng CIDv1" --> IPFS
        </div>
    </div>

    <!-- 2. Smart Contracts -->
    <div class="diagram-container">
        <h2>2. H·ª£p ƒê·ªìng Th√¥ng Minh (Smart Contracts)</h2>
        <p class="description">Chi ti·∫øt c√°c Contract v√† m·ªëi quan h·ªá k·∫ø th·ª´a/t∆∞∆°ng t√°c.</p>
        <div class="mermaid">
            classDiagram
            class Ownable {
            +owner()
            +renounceOwnership()
            +transferOwnership()
            }
            class Pausable {
            +paused()
            +pause()
            +unpause()
            }
            class ERC721 {
            +balanceOf()
            +ownerOf()
            +transferFrom()
            }
            class ERC4907 {
            +setUser(tokenId, user, expires)
            +userOf(tokenId)
            +userExpires(tokenId)
            }
            class FunctionsClient {
            +sendRequest()
            }
            class AutomationCompatibleInterface {
            +checkUpkeep()
            +performUpkeep()
            }

            class BookAsset {
            &lt;&lt;ERC-4907&gt;&gt;
            +safeMint(to, cid)
            +verifyForListing()
            +verifyPreRent()
            +verifyReturn()
            }
            BookAsset --|&gt; ERC4907
            BookAsset --|&gt; Ownable
            BookAsset --|&gt; Pausable

            class RentalAgreementSBT {
            &lt;&lt;Soulbound&gt;&gt;
            +rentalTerms (mapping)
            -_update() [Overrides transfer]
            }
            RentalAgreementSBT --|&gt; ERC721
            RentalAgreementSBT --|&gt; Ownable
            note for RentalAgreementSBT "Kh√¥ng th·ªÉ chuy·ªÉn nh∆∞·ª£ng (Soulbound)"

            class VinaLibVault {
            &lt;&lt;Ledger&gt;&gt;
            +activeRentals (mapping)
            +rentalToSBT (mapping - v3.0)
            +createRental(..., existingSbtId)
            +requestReturn()
            +confirmReturn()
            }
            VinaLibVault --|&gt; FunctionsClient
            VinaLibVault --|&gt; AutomationCompatibleInterface
            VinaLibVault --|&gt; Ownable
            VinaLibVault ..&gt; BookAsset : qu·∫£n l√Ω tr·∫°ng th√°i
            VinaLibVault ..&gt; RentalAgreementSBT : record SBT ID

            class SuChinToken {
            &lt;&lt;ERC-20&gt;&gt;
            +mint()
            }
            SuChinToken --|&gt; Ownable
        </div>
    </div>

    <!-- 3. IPFS Architecture and Data Flow -->
    <div class="diagram-container">
        <h2>3. IPFS - Ki·∫øn Tr√∫c v√† Lu·ªìng D·ªØ Li·ªáu</h2>
        <p class="description">T·ªïng quan v·ªÅ h·ªá th·ªëng l∆∞u tr·ªØ ph√¢n t√°n IPFS v√† c√°ch t√≠ch h·ª£p v√†o VinaLib.</p>

        <h3 style="color: #2980b9; margin-top: 20px;">3.1. M·∫°ng l∆∞·ªõi IPFS (IPFS Network Topology)</h3>
        <div class="mermaid">
            graph TB
            subgraph "M·∫°ng L∆∞·ªõi IPFS"
            Node1[Node IPFS 1<br />Ch√¢u √Å]
            Node2[Node IPFS 2<br />Ch√¢u √Çu]
            Node3[Node IPFS 3<br />Ch√¢u M·ªπ]
            Node4[Node IPFS 4<br />Ch√¢u Phi]

            DHT[(B·∫£ng BƒÉm<br />Ph√¢n T√°n)]
            end

            User[Ng∆∞·ªùi D√πng Cu·ªëi] -->|Truy v·∫•n CID| Node1
            Node1 <-->|Kh√°m Ph√° Peer| DHT
                DHT -->|Tr·∫£ V·ªÅ Providers| Node1

                Node1 <-.->|K·∫øt N·ªëi P2P| Node2
                    Node1 <-.->|K·∫øt N·ªëi P2P| Node3
                        Node2 <-.->|K·∫øt N·ªëi P2P| Node4
                            Node3 <-.->|K·∫øt N·ªëi P2P| Node4

                                Node2 -->|Truy·ªÅn Block| Node1
                                Node3 -->|Truy·ªÅn Block| Node1

                                Node1 -->|D·ªØ Li·ªáu ƒê√£ Gh√©p| User

                                classDef nodeStyle fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
                                classDef userStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
                                classDef dhtStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px

                                class Node1,Node2,Node3,Node4 nodeStyle
                                class User userStyle
                                class DHT dhtStyle
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">3.2. Quy Tr√¨nh Truy Xu·∫•t D·ªØ Li·ªáu (Content Routing Flow)</h3>
        <div class="mermaid">
            sequenceDiagram
            autonumber
            participant User as Node IPFS C·ªßa Ng∆∞·ªùi D√πng
            participant DHT as B·∫£ng BƒÉm Ph√¢n T√°n (DHT)
            participant P1 as Peer Cung C·∫•p 1
            participant P2 as Peer Cung C·∫•p 2
            participant P3 as Peer Cung C·∫•p 3

            Note over User: Ng∆∞·ªùi d√πng y√™u c·∫ßu CID:<br />bafybei...

            User->>DHT: FIND_PROVIDERS(CID)
            DHT->>DHT: Kademlia Lookup<br />(Kho·∫£ng c√°ch XOR)

            DHT-->>User: Danh s√°ch Provider:<br />P1, P2, P3

            par L·∫•y Block Song Song
            User->>P1: WANT_BLOCK(block_0)
            User->>P2: WANT_BLOCK(block_1)
            User->>P3: WANT_BLOCK(block_2)
            end

            par Ph·∫£n H·ªìi
            P1-->>User: BLOCK_DATA(block_0)
            P2-->>User: BLOCK_DATA(block_1)
            P3-->>User: BLOCK_DATA(block_2)
            end

            User->>User: X√°c Th·ª±c Hash<br />(SHA-256)
            User->>User: L·∫Øp R√°p l·∫°i DAG

            Note over User: N·ªôi Dung S·∫µn S√†ng!
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">3.3. IPFS Gateway Architecture</h3>
        <div class="mermaid">
            graph LR
            subgraph "Ph√≠a Client"
            Browser[Tr√¨nh Duy·ªát Web]
            end

            subgraph "Gateway (B·ªô chuy·ªÉn ƒë·ªïi HTTP ‚Üî IPFS)"
            GW[M√°y Ch·ªß Gateway IPFS]
            Node[Node IPFS Nh√∫ng]
            Cache[L·ªõp Cache HTTP]
            end

            subgraph "M·∫°ng L∆∞·ªõi IPFS"
            P2P[M·∫°ng P2P<br />Peers To√†n C·∫ßu]
            end

            Browser -->|"HTTP GET<br />https://gateway/ipfs/CID"| GW
            GW -->|1. Ki·ªÉm Tra Cache| Cache
            Cache -.->|Kh√¥ng Th·∫•y Cache| Node
            Node -->|2. L·∫•y qua Bitswap| P2P
            P2P -->|3. Tr·∫£ V·ªÅ Blocks| Node
            Node -->|4. L·∫Øp R√°p| GW
            GW -->|"5. Ph·∫£n H·ªìi HTTP<br />+ Cache Headers"| Browser
            Cache -.->|T√¨m Th·∫•y Cache| GW

            classDef gateway fill:#fff3e0,stroke:#e65100,stroke-width:2px
            classDef ipfs fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
            classDef client fill:#e3f2fd,stroke:#1565c0,stroke-width:2px

            class GW,Node,Cache gateway
            class P2P ipfs
            class Browser client
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">3.4. T√≠ch h·ª£p IPFS v√†o VinaLib (IPFS Integration)</h3>
        <p class="description">Hi·ªán t·∫°i s·ª≠ d·ª•ng IPFS Simulator (Local) ƒë·ªÉ m√¥ ph·ªèng h√†nh vi l∆∞u tr·ªØ ph√¢n t√°n.</p>
        <div class="mermaid">
            graph TB
            subgraph "Frontend (React/Next.js)"
            UI["Giao di·ªán Ng∆∞·ªùi d√πng"]
            UploadBtn["N√∫t T·∫£i ·∫£nh B√¨a"]
            DisplayImg["Component Hi·ªÉn th·ªã ·∫¢nh"]
            end

            subgraph "Backend (Node.js)"
            API["Express Server"]
            IPFSMod["Module IPFS<br />(Simulator Adapter)"]
            LocalFS["H·ªá Th·ªëng File C·ª•c B·ªô<br />/IPFS/storage"]
            end

            subgraph "Blockchain (Avalanche)"
            Contract["Smart Contract:<br />BookAsset.sol"]
            Storage["L∆∞u Tr·ªØ:<br />mapping bookId to CID"]
            end

            UploadBtn -->|1. Ch·ªçn ·∫¢nh| API
            API -->|2. Lu·ªìng T·∫£i L√™n| IPFSMod
            IPFSMod -->|3. BƒÉm SHA-256| IPFSMod
            IPFSMod -->|4. L∆∞u File| LocalFS
            IPFSMod -->|5. Tr·∫£ v·ªÅ CID| API
            API -->|6. L∆∞u CID| Contract
            Contract -->|7. Ph√°t S·ª± Ki·ªán| Storage

            UI -->|8. L·∫•y D·ªØ Li·ªáu S√°ch| Contract
            Contract -->|9. Tr·∫£ v·ªÅ CID| UI
            DisplayImg -->|10. Y√™u c·∫ßu /api/ipfs/:cid| API
            API -->|11. ƒê·ªçc File| LocalFS
            API -->|12. Tr·∫£ v·ªÅ Lu·ªìng ·∫¢nh| DisplayImg

            classDef frontend fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
            classDef backend fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
            classDef blockchain fill:#fff3e0,stroke:#e65100,stroke-width:2px
            classDef storage fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px

            class UI,UploadBtn,DisplayImg frontend
            class API,IPFSMod backend
            class Contract,Storage blockchain
            class LocalFS storage
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">3.5. Data Retrieval v√† Rendering Pipeline</h3>
        <div class="mermaid">
            sequenceDiagram
            autonumber
            participant User as Tr√¨nh Duy·ªát Ng∆∞·ªùi D√πng
            participant GW as Gateway IPFS
            participant IPFS as M·∫°ng L∆∞·ªõi IPFS
            participant Render as B·ªô Render Tr√¨nh Duy·ªát

            User->>GW: GET /ipfs/bafybei.../video.mp4

            GW->>IPFS: Truy v·∫•n Providers qua DHT
            IPFS-->>GW: Danh s√°ch Provider

            GW->>IPFS: L·∫•y Block G·ªëc
            IPFS-->>GW: Block G·ªëc (Metadata)

            Note over GW: Ph√¢n t√°ch c·∫•u tr√∫c DAG:<br />- T·ªïng k√≠ch th∆∞·ªõc<br />- Danh s√°ch Chunk

            par T·∫£i Chunk Song Song
            GW->>IPFS: L·∫•y Chunk 1
            GW->>IPFS: L·∫•y Chunk 2
            GW->>IPFS: L·∫•y Chunk 3
            end

            par Ph·∫£n H·ªìi Chunk Song Song
            IPFS-->>GW: D·ªØ li·ªáu Chunk 1
            IPFS-->>GW: D·ªØ li·ªáu Chunk 2
            IPFS-->>GW: D·ªØ li·ªáu Chunk 3
            end

            loop Cho M·ªói Chunk
            GW->>GW: X√°c th·ª±c Hash<br />SHA-256(chunk) == expected_hash
            end

            GW->>GW: L·∫Øp r√°p Chunk th√†nh File

            GW->>User: HTTP 200 OK<br />Content-Type: video/mp4<br />Content-Length: 10485760<br />[Stream Data]

            User->>Render: Gi·∫£i m√£ Video Stream
            Render->>Render: Gi·∫£i m√£ H.264/H.265
            Render-->>User: Hi·ªÉn th·ªã Video
        </div>
    </div>

    <!-- 4. Backend -->
    <div class="diagram-container">
        <h2>4. ƒê·ªãnh v·ªã vai tr√≤ cho backend</h2>
        <p class="description">Backend ƒë√£ chuy·ªÉn t·ª´ trung t√¢m ƒëi·ªÅu ph·ªëi logic sang vai tr√≤ h·ªó tr·ª£ Off-chain, nh∆∞·ªùng v·ªã
            tr√≠ c·ªët l√µi cho Smart Contracts.</p>
        <div class="mermaid">
            graph TD
            classDef core fill:#fff3e0,stroke:#e65100,stroke-width:2px;
            classDef current fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef future fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

            subgraph The_Core [Ngu·ªìn Ch√¢n L√Ω Duy Nh·∫•t (Single Source of Truth)]
            SC["Smart Contracts (.sol)<br />Ch·ª©a to√†n b·ªô Business Flows & State Machine"]:::core
            end

            subgraph Current_Role [Tr·∫°ng th√°i Hi·ªán T·∫°i (H·ªó tr·ª£ Off-chain)]
            UI["Ph·ª•c v·ª• UI (Bootstrapper)<br />Ch·∫°y & ph√¢n ph·ªëi React DApp"]:::current
            Adapter["Adapter & Middleware<br />Giao ti·∫øp Mock API, eContract, IoT"]:::current
            OffChain["X·ª≠ l√Ω Off-chain<br />Policy Engine, Contract Generator, IPFS Sim"]:::current
            end

            subgraph Future_Role [ƒê·ªãnh h∆∞·ªõng T∆∞∆°ng Lai (True DApp)]
            Thin[Backend m·ªèng d·∫ßn<br />Frontend t∆∞∆°ng t√°c tr·ª±c ti·∫øp RPC/Ethers.js]:::future
            Microservices[Microservices/Workers<br />L·∫Øng nghe On-chain Events (vd: g·ª≠i Email)]:::future
            Decentralized[Phi t·∫≠p trung l∆∞u tr·ªØ<br />IPFS v√† On-chain thay th·∫ø DB t·∫≠p trung]:::future
            end

            The_Core -. "Backend thu h·∫πp l·∫°i xung quanh l√µi" .-> Current_Role
            Current_Role -. "Ti·∫øn t·ªõi ph√¢n t√°n ho√†n to√†n" .-> Future_Role
        </div>
    </div>

    <!-- 5. Frontend -->
    <div class="diagram-container">
        <h2>5. C·∫•u Tr√∫c Frontend (FSD)</h2>
        <p class="description">Tu√¢n th·ªß Feature-Sliced Design. ƒê√£ t√≠ch h·ª£p module Explorer.</p>
        <div class="mermaid">
            graph TD
            classDef app fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef page fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
            classDef shared fill:#e0f2f1,stroke:#00695c,stroke-width:2px;
            classDef empty fill:#fafafa,stroke:#bdbdbd,stroke-width:1px,stroke-dasharray: 5 5;

            subgraph App_Layer [T·∫ßng ·ª®ng D·ª•ng - App Layer]
            App["App.tsx"]:::app
            Providers[Providers]:::app
            Styles[Styles To√†n C·ª•c]:::app
            end

            subgraph Pages_Layer [T·∫ßng Trang - Pages Layer]
            Login[LoginPage]:::page
            Register[RegisterPage]:::page
            Home[HomePage]:::page
            Explorer["C√°c Trang Explorer"]:::page
            Account[AccountPage]:::page
            Wallet[WalletPage]:::page
            RentOut[RentOutPage]:::page
            BookDetail[BookDetail]:::page
            Settings[Settings]:::page
            Owner[OwnerDashboard]:::page
            Lender[LenderDashboard]:::page
            ContractPreview[ContractPreviewPage]:::page
            end

            subgraph Shared_Layer [T·∫ßng D√πng Chung - Shared Layer]
            UI["UI Kit - Button, Input"]:::shared
            API["Axios Config"]:::shared
            Lib["Utils"]:::shared
            end

            subgraph Empty_Layers_Phase1 [C√°c T·∫ßng Ch·ªù - Pending Phase 2]
            Widgets["Widgets (.gitkeep)"]:::empty
            Features["Features (.gitkeep)"]:::empty
            Entities["Entities (.gitkeep)"]:::empty
            end

            App -- "ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn" --> Login
            App -- "ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn" --> Home
            App -- "ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn" --> Explorer
            App -- "ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn" --> Owner

            Login -- "Nh√∫ng th√†nh ph·∫ßn" --> UI
            Home -- "Nh√∫ng th√†nh ph·∫ßn" --> UI
            Explorer -- "Nh√∫ng th√†nh ph·∫ßn" --> UI
            Owner -- "Nh√∫ng th√†nh ph·∫ßn" --> UI
        </div>
    </div>

    <!-- 6. Workflow -->
    <div class="diagram-container">
        <h2>6. Data Flow - Quy tr√¨nh thu√™ s√°ch (Rental Workflow)</h2>
        <p class="description">Minh h·ªça quy tr√¨nh thu√™, x√°c th·ª±c 2 chi·ªÅu (User Request &lt;-&gt; Admin Confirm) v√† thanh
            to√°n
            Off-chain.</p>
        <div class="mermaid">
            sequenceDiagram
            autonumber

            box "Ng∆∞·ªùi D√πng (User Zone)" #e3f2fd
            actor User as Renter (Ng∆∞·ªùi thu√™)
            participant FE as Frontend UI
            end

            box "H·ªá Th·ªëng X·ª≠ L√Ω (System Zone)" #e8f5e9
            participant BE as Backend API
            participant SC as Smart Contracts
            end

            box "D·ªãch V·ª• & Qu·∫£n Tr·ªã (External)" #fff3e0
            participant Legal as Mock Legal
            actor Admin as Administrator
            end

            %% Giai ƒëo·∫°n 1
            rect rgb(240, 248, 255)
            note right of User: B∆∞·ªõc 1: Thi·∫øt l·∫≠p & ƒêƒÉng s√°ch (Setup & Listing)
            User->>FE: T·∫£i l√™n Th√¥ng Tin S√°ch
            FE->>BE: POST /api/books (Ch·ªù x·ª≠ l√Ω)
            BE->>BE: L∆∞u v√†o B·ªô Nh·ªõ
            Admin->>FE: Duy·ªát ƒêƒÉng Tin (Dashboard Ch·ªß S√°ch)
            alt X√°c Minh (Ch·∫•p thu·∫≠n)
            FE->>BE: POST verify-listing
            BE->>SC: BookAsset.verifyForListing()
            SC-->>BE: S·ª± ki·ªán: BookVerified
            BE-->>FE: Tr·∫°ng th√°i -> VERIFIED
            else T·ª´ Ch·ªëi (H·ªßy)
            FE->>BE: POST reject-listing (C·∫ßn l√Ω do)
            BE->>BE: Update Tr·∫°ng th√°i -> REJECTED
            BE-->>FE: Th√¥ng b√°o cho Ng∆∞·ªùi Cho Thu√™
            end
            end

            %% Giai ƒëo·∫°n 2
            rect rgb(255, 248, 240)
            note right of User: B∆∞·ªõc 2: ƒê·∫∑t thu√™ & K√Ω k·∫øt (Booking & Contracts)
            User->>FE: T·∫°o Y√™u c·∫ßu Thu√™
            FE->>BE: POST /api/booking
            BE->>Legal: T·∫°o Xem Tr∆∞·ªõc H·ª£p ƒê·ªìng
            Legal-->>BE: Tr·∫£ v·ªÅ previewId, termsHash
            User->>FE: Xem l·∫°i H·ª£p ƒë·ªìng (Xem tr∆∞·ªõc)
            User->>FE: Ch·∫•p thu·∫≠n & K√Ω (Nh·∫•n n√∫t K√Ω)
            FE->>BE: POST /api/contracts/:id/accept

            BE->>BE: Ki·ªÉm tra Policy Engine (TrustScore)
            alt AUTO APPROVED
            BE-->>FE: Tr·∫°ng th√°i -> SIGNED_UNPAID
            else REVIEW NEEDED
            BE-->>FE: Tr·∫°ng th√°i -> SIGNED_PENDING_APPROVAL
            Admin->>FE: Duy·ªát Y√™u C·∫ßu Thu√™ (Th·ªß c√¥ng)
            FE->>BE: Logic Duy·ªát
            BE-->>FE: Tr·∫°ng th√°i -> SIGNED_UNPAID
            end
            end

            %% Giai ƒëo·∫°n 3
            rect rgb(240, 255, 240)
            note right of User: B∆∞·ªõc 3: Thanh to√°n & ƒê√∫c Token (Payment & Minting)
            User->>FE: Thanh to√°n qua V√≠/Ng√¢n h√†ng
            FE->>BE: Webhook Thanh to√°n/T√≠n hi·ªáu
            BE->>SC: VinaLibVault.createRental(..., existingSbtId)
            activate SC
            SC->>SC: Ki·ªÉm tra Tr·∫°ng th√°i X√°c minh
            SC->>SC: Ghi nh·∫≠n SBT ID (ƒë√£ ƒë√∫c)
            SC->>SC: BookAsset.setUser(User)
            SC-->>BE: S·ª± ki·ªán: RentalCreated
            deactivate SC
            BE-->>FE: Thu√™ ƒêang Ho·∫°t ƒê·ªông (M·ªü kh√≥a thi·∫øt b·ªã c√≥ s·∫µn)
            end

            %% Giai ƒëo·∫°n 4
            rect rgb(255, 240, 245)
            note right of User: B∆∞·ªõc 4: Quy tr√¨nh Tr·∫£ s√°ch (Return Process)
            User->>FE: Y√™u c·∫ßu Tr·∫£
            FE->>BE: G·ª≠i Y√™u C·∫ßu Tr·∫£
            BE->>SC: VinaLibVault.requestReturn()

            Admin->>FE: X√°c nh·∫≠n Tr·∫£ V·∫≠t l√Ω
            FE->>BE: X√°c nh·∫≠n H√†nh ƒë·ªông Tr·∫£
            BE->>SC: VinaLibVault.confirmReturn()
            activate SC
            SC->>SC: Thu h·ªìi Quy·ªÅn Ng∆∞·ªùi D√πng
            SC->>SC: ƒê√°nh d·∫•u EvidencePack l√† ƒê√£ K·∫øt Th√∫c
            deactivate SC
            BE-->>FE: Tr·∫°ng th√°i -> COMPLETED
            end
        </div>
    </div>

    <!-- 7. Interaction -->
    <div class="diagram-container">
        <h2>7. Interaction Flows (Actors)</h2>
        <p class="description">Quy·ªÅn h·∫°n c·ªßa c√°c t√°c nh√¢n trong h·ªá th·ªëng (RBAC).</p>
        <div class="mermaid">
            graph LR
            %% Styles
            classDef actor fill:#f9f9f9,stroke:#333,stroke-width:2px;
            classDef action fill:#e1f5fe,stroke:#0288d1,stroke-width:1px;
            classDef adminAction fill:#ffebee,stroke:#c62828,stroke-width:1px;

            subgraph Renter_Zone [Khu v·ª±c Ng∆∞·ªùi Thu√™ - Renter]
            direction TB
            Renter((Renter)):::actor
            Browse["Xem s√°ch"]:::action
            Booking["ƒê·∫∑t thu√™"]:::action
            Sign["K√Ω H·ª£p ƒê·ªìng"]:::action
            Pay["Thanh to√°n & M·ªü kh√≥a"]:::action
            Return["Y√™u c·∫ßu Tr·∫£"]:::action

            Renter -- "User Role" --> Browse
            Renter -- "User Role" --> Booking
            Renter -- "User Role" --> Sign
            Renter -- "User Role" --> Pay
            Renter -- "User Role" --> Return
            end

            subgraph Lender_Zone [Khu v·ª±c Ch·ªß S√°ch - Lender]
            direction TB
            Lender((Lender)):::actor
            Upload["ƒêƒÉng s√°ch l√™n"]:::action
            ViewOwn["Xem s√°ch ƒë√£ ƒëƒÉng"]:::action

            Lender -- "Lender Role" --> Upload
            Lender -- "Lender Role" --> ViewOwn
            end

            subgraph Admin_Zone [Khu v·ª±c Qu·∫£n Tr·ªã - Admin]
            direction TB
            Admin((Admin)):::actor
            Verify["Duy·ªát s√°ch l√™n s√†n"]:::adminAction
            Approve["Duy·ªát ƒë∆°n thu√™ (Th·ªß c√¥ng)"]:::adminAction
            Confirm["X√°c nh·∫≠n Tr·∫£ s√°ch"]:::adminAction
            Monitor["Gi√°m s√°t H·ªá th·ªëng"]:::adminAction

            Admin -- "Admin Role" --> Verify
            Admin -- "Admin Role" --> Approve
            Admin -- "Admin Role" --> Confirm
            Admin -- "Admin Role" --> Monitor
            end

            %% Interactions across zones
            Booking -. "C·∫ßn duy·ªát n·∫øu R·ªßi ro Cao" .-> Approve
            Return -. "C·∫ßn x√°c nh·∫≠n V·∫≠t l√Ω" .-> Confirm
        </div>
    </div>

    <!-- 8. Mocks -->
    <div class="diagram-container">
        <h2>8. D·ªãch V·ª• Gi·∫£ L·∫≠p & C·∫•u Tr√∫c IPFS</h2>
        <p class="description">C√°c d·ªãch v·ª• gi·∫£ l·∫≠p h·ªó tr·ª£ h·ªá th·ªëng (Ch·∫°y tr√™n Port 4000).</p>
        <div class="mermaid">
            graph TD
            classDef mock fill:#fff3e0,stroke:#e65100,stroke-width:2px;
            classDef ipfs fill:#e0f7fa,stroke:#006064,stroke-width:2px;

            subgraph Mocks [D·ªãch V·ª• Gi·∫£ L·∫≠p - Mock Services :4000]
            MockApp["mock-server/index.js"]:::mock
            Legal["D·ªãch V·ª• Ph√°p L√Ω<br />FPT eContract"]:::mock
            IoT["D·ªãch V·ª• IoT<br />Tuya Smart Lock"]:::mock
            Bank["D·ªãch V·ª• Ng√¢n H√†ng<br />Casso Webhook"]:::mock
            end

            subgraph IPFS [Gi·∫£ L·∫≠p IPFS - Tr√¨nh M√¥ Ph·ªèng IPFS]
            Images["images/*.jpg"]:::ipfs
            Meta["metadata/*.json"]:::ipfs
            Route["/api/ipfs/:cid<br />(Ch·∫ø ƒë·ªô Proxy)"]:::ipfs
            end

            MockApp -- "Ch·∫°y" --> Legal
            MockApp -- "Ch·∫°y" --> IoT
            MockApp -- "Ch·∫°y" --> Bank

            Legal -- cung c·∫•p --> TermsHash
            IoT -- cung c·∫•p --> Ticket/OTP
            Bank -- cung c·∫•p --> PaymentWebhook

            Images -. "ƒê∆∞·ª£c bƒÉm th√†nh" .-> CIDv1
            Meta -. "ƒê∆∞·ª£c bƒÉm th√†nh" .-> CIDv1
        </div>
    </div>

    <!-- 9. Functional Mapping -->
    <div class="diagram-container">
        <h2>9. S∆° ƒë·ªì √Ånh x·∫° Ch·ª©c nƒÉng: Thu√™ S√°ch (Functional Mapping: Rent Book)</h2>
        <p class="description">B·∫£n ƒë·ªì √°nh x·∫° chi ti·∫øt t·ª´ th√†nh ph·∫ßn Giao di·ªán (Frontend) ƒë·∫øn Logic x·ª≠ l√Ω (Backend) v√†
            H√†m Blockchain (Smart Contracts) cho t√≠nh nƒÉng quan tr·ªçng nh·∫•t: Thu√™ S√°ch.</p>
        <div class="mermaid">
            graph LR
            %% Styles
            classDef ui fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef sc fill:#fff3e0,stroke:#e65100,stroke-width:2px;
            classDef middleware fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

            subgraph Frontend_Layer [T·∫ßng Giao Di·ªán - React DApp]
            direction TB
            UI_Page["BookDetailPage.tsx"]:::ui
            UI_Btn[N√∫t Thu√™ MetaMask]:::ui
            UI_Page -- "Ch·ª©a" --> UI_Btn
            end

            subgraph Provider_Layer [T·∫ßng Middleware - SDK]
            direction TB
            EthersJS["ContractService.ts<br />(K√Ω Transaction b·∫±ng Wallet)"]:::middleware
            end

            subgraph Blockchain_Layer [T·∫ßng H·ª£p ƒê·ªìng - Smart Contracts]
            direction TB
            SC_Vault["VinaLibVault.sol"]:::sc
            SC_Func["createRental()"]:::sc
            SC_Asset["BookAsset.sol<br />setUser"]:::sc

            SC_Vault -- "Ch·ª©a h√†m" --> SC_Func
            SC_Func -- "G·ªçi sang" --> SC_Asset
            end

            %% Mappings (Arrows)
            UI_Btn -- "1. Y√™u c·∫ßu Confirm" --> EthersJS
            EthersJS -- "2. Ph√°t TX k√®m msg.value" --> SC_Func
        </div>
    </div>

    <!-- 10. Policy Engine Auto-Accept -->
    <div class="diagram-container">
        <h2>10. Policy Engine Auto-Accept (Phase 2) - C∆° ch·∫ø T·ª± ƒê·ªông Duy·ªát</h2>
        <p class="description">H·ªá th·ªëng ƒë√°nh gi√° r·ªßi ro d·ª±a tr√™n 3 y·∫øu t·ªë: Tier s√°ch (r·ªßi ro t√†i s·∫£n), TrustScore ng∆∞·ªùi
            thu√™ (r·ªßi ro con ng∆∞·ªùi), v√† Deposit ratio (t·ª∑ l·ªá c·ªçc). K·∫øt qu·∫£ quy·∫øt ƒë·ªãnh s·∫Ω l√† AUTO (t·ª± ƒë·ªông duy·ªát),
            REVIEW (xem x√©t ng·∫Øn h·∫°n), MANUAL (duy·ªát th·ªß c√¥ng), ho·∫∑c REJECT (t·ª´ ch·ªëi).</p>

        <h3 style="color: #2980b9; margin-top: 20px;">10.1. Quy tr√¨nh Quy·∫øt ƒë·ªãnh (Decision Flow)</h3>
        <div class="mermaid">
            flowchart TD
            Start([Ng∆∞·ªùi thu√™ k√Ω h·ª£p ƒë·ªìng<br />ƒê√£ K√Ω ƒêi·ªÅu Kho·∫£n]) --> Gate0{Ki·ªÉm tra s√°ch<br />S√°ch S·∫µn S√†ng?}

            Gate0 -->|"status ‚â† VERIFIED<br />ho·∫∑c isRented = true"| Reject1["REJECT<br />reasonCode:
            BOOK_NOT_AVAILABLE"]
            Gate0 -->|"‚úì S√°ch s·∫µn s√†ng"| CalcTrust["T√≠nh TrustScore<br />base=50
            +10*min(thu√™_xong,5)<br />-20*tranh_ch·∫•p -10*tr·ªÖ<br />gi·ªõi h·∫°n 0-100"]

            CalcTrust --> GetInputs["Thu th·∫≠p inputs:<br />‚Ä¢ tier = book.riskTier (M·∫∑c ƒë·ªãnh: C)<br />‚Ä¢ band =
            HIGH/MED/LOW<br />‚Ä¢ depositRatio = deposit/value"]

            GetInputs --> CheckTier{Tier n√†o?}

            %% Tier C Branch
            CheckTier -->|"Tier C<br />(Low Risk)"| TierC{TrustBand?}
            TierC -->|"LOW & Ratio &lt; 50%"| ReviewC["REVIEW<br />reasonCode:
            TIER_C_LOW_TRUST_NEED_REVIEW<br />deadline: +30m"]
            TierC -->|"Else"| AutoC[AUTO<br />reasonCode: TIER_C_OK<br />deadline: +60m]

            %% Tier B Branch
            CheckTier -->|"Tier B<br />(Medium Risk)"| TierB{TrustBand?}
            TierB -->|"HIGH"| AutoB1[AUTO<br />reasonCode: TIER_B_HIGH_TRUST]
            TierB -->|"MED"| DepositB1{Ratio?}
            DepositB1 -->|"‚â• 50%"| AutoB2[AUTO<br />reasonCode: TIER_B_MED_TRUST_DEPOSIT_OK]
            DepositB1 -->|"&lt; 50%"| ReviewB[REVIEW<br />reasonCode: TIER_B_MED_TRUST_REVIEW]
            TierB -->|"LOW"| DepositB2{Ratio?}
            DepositB2 -->|"‚â• 70%"| ReviewB2[REVIEW<br />reasonCode: TIER_B_LOW_TRUST_HIGH_DEPOSIT]
            DepositB2 -->|"&lt; 70%"| ManualB[MANUAL<br />reasonCode: TIER_B_LOW_TRUST_MANUAL]

            %% Tier A Branch
            CheckTier -->|"Tier A<br />(High Risk)"| TierA{TrustBand?}
            TierA -->|"LOW"| RejectA[REJECT<br />reasonCode: TIER_A_LOW_TRUST_REJECT]
            TierA -->|"Other"| ManualA[MANUAL<br />reasonCode: TIER_A_MANUAL<br />deadline: +2h]

            %% Final states
            AutoC --> StatusAuto[Status: SIGNED_UNPAID<br />approvalMode: AUTO]
            AutoB1 --> StatusAuto
            AutoB2 --> StatusAuto

            ReviewC --> StatusReview[Status: SIGNED_PENDING_APPROVAL<br />approvalMode: REVIEW]
            ReviewB --> StatusReview
            ReviewB2 --> StatusReview

            ManualB --> StatusManual[Status: SIGNED_PENDING_APPROVAL<br />approvalMode: MANUAL]
            ManualA --> StatusManual

            Reject1 --> StatusReject[Status: REJECTED]
            RejectA --> StatusReject

            %% Styles
            classDef autoClass fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px;
            classDef reviewClass fill:#fff9c4,stroke:#f57f17,stroke-width:2px;
            classDef manualClass fill:#ffccbc,stroke:#d84315,stroke-width:2px;
            classDef rejectClass fill:#ffcdd2,stroke:#c62828,stroke-width:2px;

            class AutoC,AutoB1,AutoB2,StatusAuto autoClass;
            class ReviewC,ReviewB,ReviewB2,StatusReview reviewClass;
            class ManualB,ManualA,StatusManual manualClass;
            class Reject1,RejectA,StatusReject rejectClass;
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">10.2. B·∫£ng Ma tr·∫≠n Ch√≠nh s√°ch (Policy Matrix)</h3>
        <p class="description">T√≥m t·∫Øt quy·∫øt ƒë·ªãnh d·ª±a tr√™n t·ª´ng t·ªï h·ª£p Tier √ó TrustScore √ó Deposit Ratio.</p>
        <div class="mermaid">
            graph TB
            subgraph Legend [Ch√∫ Gi·∫£i K·∫øt Qu·∫£]
            Auto["üü¢ AUTO = T·ª± ƒë·ªông duy·ªát ngay"]
            Review["üü° REVIEW = Xem x√©t trong 30 ph√∫t"]
            Manual["üü† MANUAL = C·∫ßn duy·ªát th·ªß c√¥ng (2h)"]
            Reject["üî¥ REJECT = T·ª´ ch·ªëi"]
            end

            subgraph TierC_Matrix [Tier C - S√°ch R·ªßi Ro Th·∫•p]
            direction LR
            TC_Title["<b>TIER C</b><br />(S√°ch r·ªßi ro th·∫•p)"]
            TC1["Trust: CAO<br />C·ªçc ‚â•30%<br />‚Üí üü¢ AUTO"]
            TC2["Trust: TB<br />C·ªçc ‚â•30%<br />‚Üí üü¢ AUTO"]
            TC3["Trust: TH·∫§P<br />C·ªçc ‚â•50%<br />‚Üí üü¢ AUTO"]
            TC4["Trust: TH·∫§P<br />C·ªçc &lt;50%<br />‚Üí üü° REVIEW"]
            end

            subgraph TierB_Matrix [Tier B - S√°ch R·ªßi Ro Trung B√¨nh]
            direction LR
            TB_Title["<b>TIER B</b><br />(S√°ch r·ªßi ro trung b√¨nh)"]
            TB1["Trust: CAO<br />C·ªçc ‚â•30%<br />‚Üí üü¢ AUTO"]
            TB2["Trust: TB<br />C·ªçc ‚â•50%<br />‚Üí üü¢ AUTO"]
            TB3["Trust: TB<br />C·ªçc &lt;50%<br />‚Üí üü° REVIEW"]
            TB4["Trust: TH·∫§P<br />C·ªçc ‚â•70%<br />‚Üí üü° REVIEW"]
            TB5["Trust: TH·∫§P<br />C·ªçc &lt;70%<br />‚Üí üü† MANUAL"]
            end

            subgraph TierA_Matrix [Tier A - S√°ch R·ªßi Ro Cao]
            direction LR
            TA_Title["<b>TIER A</b><br />(S√°ch r·ªßi ro cao)"]
            TA1["Trust: CAO/TB<br />B·∫•t k·ª≥ m·ª©c c·ªçc<br />‚Üí üü† MANUAL"]
            TA2["Trust: TH·∫§P<br />B·∫•t k·ª≥ m·ª©c c·ªçc<br />‚Üí üî¥ REJECT"]
            end

            subgraph TrustCalc [C√°ch t√≠nh TrustScore]
            direction TB
            TCalc["ƒêi·ªÉm = 50<br />+ 10 √ó min(thu√™_xong, 5)<br />- 20 √ó tranh_ch·∫•p<br />- 10 √ó tr·∫£_mu·ªôn<br /><br />CAO:
            ‚â•80<br />TB: 50-79<br />TH·∫§P: &lt;50"]
            end

            %% Styles
            classDef tierStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000;
            classDef legendStyle fill:#fff,stroke:#666,stroke-width:1px,color:#000;
            classDef calcStyle fill:#fffde7,stroke:#f9a825,stroke-width:2px,color:#000;

            class TC_Title,TB_Title,TA_Title tierStyle;
            class TC1,TC2,TC3,TC4,TB1,TB2,TB3,TB4,TB5,TA1,TA2 legendStyle;
            class TCalc calcStyle;
            class Auto,Review,Manual,Reject legendStyle;
        </div>

        <h3 style="color: #2980b9; margin-top: 30px;">10.3. X·ª≠ l√Ω Timeout v√† SLA</h3>
        <div class="mermaid">
            sequenceDiagram
            autonumber

            participant User as Renter
            participant BE as Backend
            participant Worker as Cron Worker
            participant Admin as Administrator

            Note over User,Admin: Tr∆∞·ªùng h·ª£p AUTO
            User->>BE: K√Ω ƒêi·ªÅu Kho·∫£n
            BE->>BE: Policy ‚Üí AUTO
            BE-->>User: Tr·∫°ng th√°i: SIGNED_UNPAID<br />H·∫°n l·∫•y: +60m
            Note over User: Ng∆∞·ªùi d√πng thanh to√°n trong 60 ph√∫t

            rect rgb(255, 248, 220)
            Note over User,Admin: Tr∆∞·ªùng h·ª£p REVIEW
            User->>BE: K√Ω ƒêi·ªÅu Kho·∫£n
            BE->>BE: Policy ‚Üí REVIEW
            BE-->>User: Tr·∫°ng th√°i: SIGNED_PENDING_APPROVAL<br />H·∫°n xem x√©t: +30m
            Worker->>BE: Ch·∫°y runReview() m·ªói 5 ph√∫t
            alt Duy·ªát Th√†nh C√¥ng
            BE->>BE: reviewState = PASSED
            BE-->>User: Tr·∫°ng th√°i: SIGNED_UNPAID
            else Duy·ªát Th·∫•t B·∫°i ho·∫∑c Timeout &gt; 30m
            BE->>BE: reviewState = FAILED
            BE-->>User: Tr·∫°ng th√°i: EXPIRED/REJECTED
            BE->>BE: Gi·∫£i ph√≥ng gi·ªØ s√°ch + Ho√†n ti·ªÅn n·∫øu ƒë√£ tr·∫£ ti·ªÅn
            end
            end

            rect rgb(255, 240, 245)
            Note over User,Admin: Tr∆∞·ªùng h·ª£p MANUAL
            User->>BE: K√Ω ƒêi·ªÅu Kho·∫£n
            BE->>BE: Policy ‚Üí MANUAL
            BE-->>User: Tr·∫°ng th√°i: SIGNED_PENDING_APPROVAL<br />H·∫°n duy·ªát: +2h
            Admin->>BE: Duy·ªát Y√™u C·∫ßu
            BE->>BE: Ki·ªÉm tra h·∫°n ch∆∞a qua
            alt Duy·ªát tr∆∞·ªõc deadline
            BE-->>User: Tr·∫°ng th√°i: SIGNED_UNPAID
            else Timeout &gt; 2h (kh√¥ng c√≥ h√†nh ƒë·ªông)
            Worker->>BE: Booking H·∫øt H·∫°n
            BE-->>User: Tr·∫°ng th√°i: EXPIRED
            BE->>BE: Gi·∫£i ph√≥ng gi·ªØ + Th√¥ng b√°o
            end
            end
        </div>
    </div>

    <!-- 11. Contract Generator -->
    <div class="diagram-container">
        <h2>11. Quy tr√¨nh T·∫°o H·ª£p ƒê·ªìng (Contract Generator Module)</h2>
        <p class="description">Quy tr√¨nh sinh h·ª£p ƒë·ªìng ƒë·ªông t·ª´ Template, ƒëi·ªÅn bi·∫øn, hash SHA-256 (cho SBT) v√† l∆∞u tr·ªØ
            t·∫°m th·ªùi
            (TTL).</p>
        <div class="mermaid">
            flowchart TD
            classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef storage fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
            classDef output fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px;

            subgraph Inputs [D·ªØ li·ªáu ƒê·∫ßu v√†o]
            Template["Template H·ª£p ƒê·ªìng<br />(Markdown + Variables)"]
            Data["Metadata Thu√™<br />(User, Book, Dates)"]
            Config["Config JSON<br />(M·∫∑c ƒë·ªãnh, Ph√≠)"]
            end

            subgraph Generator [Module T·∫°o H·ª£p ƒê·ªìng]
            Fill["ƒêi·ªÅn bi·∫øn (L·∫•p ƒë·∫ßy v·ªã tr√≠)"]
            Hash["T√≠nh TermsHash (SHA-256)"]
            UUID["T·∫°o Preview ID (UUIDv4)"]
            end

            subgraph TempStore [B·ªô nh·ªõ ƒë·ªám - TempStore.js]
            Store["In-Memory Map<br />Key: PreviewID<br />Value: N·ªôi dung + Hash"]
            end

            subgraph Outputs [K·∫øt qu·∫£ & H√†nh ƒê·ªông]
            PreviewAPI["GET /api/contracts/:id"]
            AcceptAPI["POST /api/contracts/:id/accept"]
            end

            Template --> Fill
            Data --> Fill
            Config --> Fill
            Fill -- "Raw Content" --> Hash
            Fill -- "Content" --> UUID
            Hash --> UUID
            UUID --> Store

            Store -. "Read" .-> PreviewAPI
            AcceptAPI -- "Update Status" --> Store
            AcceptAPI -- "Return Hash & ID" --> BackendFlow["RentalController"]

            class Fill,Hash,UUID process
            class Store storage
            class PreviewAPI,AcceptAPI output
        </div>
    </div>

    <!-- 12. Blockchain Explorer -->
    <div class="diagram-container">
        <h2>12. Ki·∫øn tr√∫c Blockchain Explorer (SuChinDB Explorer)</h2>
        <p class="description">C√¥ng c·ª• tra c·ª©u d·ªØ li·ªáu on-chain, s·ª≠ d·ª•ng Service Layer ƒë·ªÉ g·ªçi JSON-RPC.</p>
        <div class="mermaid">
            graph LR
            subgraph Frontend [Giao di·ªán Explorer]
            ExplorerUI["C√°c Trang Explorer<br />(Dashboard, S·ª± ki·ªán)"]
            Service["ExplorerService<br />(ethers.JsonRpcProvider)"]
            end

            subgraph Node [Giao di·ªán Node Blockchain]
            RPC["JSON-RPC Interface<br />Port: 8545"]
            Ledger["D·ªØ Li·ªáu Block<br />(Tr·∫°ng th√°i Chu·ªói)"]
            Events["Logs S·ª± Ki·ªán<br />(B·ªô l·ªçc Topic)"]
            end

            ExplorerUI --> Service
            Service -->|"getBlock, getLogs"| RPC
            RPC --> Ledger
            RPC --> Events

            classDef ui fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
            classDef node fill:#fff3e0,stroke:#e65100,stroke-width:2px;

            class ExplorerUI,Service ui;
            class RPC,Ledger,Events node;
        </div>
    </div>

    <!-- 13. BookAsset State Machine (from EXTRACTED_LOGIC.md) -->
    <div class="diagram-container">
        <h2>13. State Machine ‚Äî BookAsset (On-Chain)</h2>
        <p class="description">M√°y tr·∫°ng th√°i NFT s√°ch tr√™n blockchain. Ngu·ªìn: EXTRACTED_LOGIC.md (Workflow
            Master_PhanTichChuyenGiao).</p>
        <div class="mermaid">
            stateDiagram-v2
            [*] --> PendingVerification : safeMint()
            PendingVerification --> Verified : verifyForListing()\n(onlyOwner)
            Verified --> Rented : markAsRented()\n(owner OR rentalContract)
            Rented --> Verified : verifyReturn(notDamaged)
            Rented --> PendingVerification : verifyReturn(isDamaged)

            note right of PendingVerification
            S√°ch m·ªõi t·∫£i l√™n
            ch·ªù Admin duy·ªát
            end note

            note right of Verified
            S·∫µn s√†ng cho thu√™
            verifyPreRent() ki·ªÉm tra
            end note

            note right of Rented
            ƒêang ƒë∆∞·ª£c thu√™
            ERC-4907 setUser active
            end note
        </div>
    </div>

    <!-- 14. EvidencePack State Machine (from EXTRACTED_LOGIC.md) -->
    <div class="diagram-container">
        <h2>14. State Machine ‚Äî EvidencePack (VinaLibVault On-Chain)</h2>
        <p class="description">Tr·∫°ng th√°i b·∫±ng ch·ª©ng thu√™ tr√™n smart contract. Ngu·ªìn: EXTRACTED_LOGIC.md.</p>
        <div class="mermaid">
            stateDiagram-v2
            [*] --> Active : createRental()\n+ Ghi nh·∫≠n existingSbtId
            Active --> ReturnRequested : requestReturn()\n(renter OR owner)
            ReturnRequested --> Concluded : confirmReturn()\n(onlyOwner)
            Active --> Concluded : confirmReturn()\n(Admin shortcut)

            note right of Active
            EvidencePack l∆∞u:
            termsHash, version,
            pspRef, renter, timestamp
            end note

            note right of Concluded
            isDamaged flag
            notes ghi ch√∫
            S√°ch tr·∫£ v·ªÅ Verified/Pending
            end note
        </div>
    </div>

    <!-- 15. Booking State Machine (Off-Chain) ‚Äî from EXTRACTED_LOGIC.md -->
    <div class="diagram-container">
        <h2>15. State Machine ‚Äî Booking (Off-Chain, 7 Tr·∫°ng Th√°i)</h2>
        <p class="description">V√≤ng ƒë·ªùi ƒë·∫ßy ƒë·ªß c·ªßa m·ªôt ƒë∆°n thu√™ trong backend. Ngu·ªìn: EXTRACTED_LOGIC.md +
            B√ÅO_C√ÅO_PH√ÇN_T√çCH_V3.md.</p>
        <div class="mermaid">
            flowchart TD
            classDef pending fill:#fff9c4,stroke:#f57f17,stroke-width:2px;
            classDef signed fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef paid fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px;
            classDef done fill:#e0f7fa,stroke:#006064,stroke-width:2px;
            classDef rejected fill:#ffcdd2,stroke:#c62828,stroke-width:2px;

            Start([POST /api/booking]) --> PA[PENDING_ACCEPTANCE]:::pending

            PA --> |"User xem preview ‚Üí accept"| PolicyCheck{Policy Engine}

            PolicyCheck --> |REJECT| Deleted[Booking DELETED]:::rejected
            PolicyCheck --> |AUTO| SU[SIGNED_UNPAID<br />+ SBT minted]:::signed
            PolicyCheck --> |REVIEW / MANUAL| SPA[SIGNED_PENDING_APPROVAL]:::pending

            SPA --> |"Admin approve"| SU
            SPA --> |"Timeout (30m/2h)"| Expired[EXPIRED]:::rejected

            SU --> |"pay-wallet"| PAID[PAID<br />+ Blockchain sync]:::paid

            PAID --> |"return-request"| RR[RETURN_REQUESTED]:::pending

            RR --> |"Admin confirm-return"| COMPLETED[COMPLETED<br />Settlement done]:::done
        </div>
    </div>

    <!-- 16. D√≤ng Ti·ªÅn Escrow (from EXTRACTED_LOGIC.md) -->
    <div class="diagram-container">
        <h2>16. D√≤ng Ti·ªÅn Off-Chain Escrow</h2>
        <p class="description">Lu·ªìng ti·ªÅn t·ª´ Renter ‚Üí Escrow ‚Üí Revenue (Platform 10%) + PendingPayout (Lender 90%).
            Ngu·ªìn: EXTRACTED_LOGIC.md.</p>
        <div class="mermaid">
            flowchart LR
            classDef renter fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
            classDef escrow fill:#fff3e0,stroke:#e65100,stroke-width:2px;
            classDef platform fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
            classDef lender fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px;

            RB["Renter Balance<br />(V√≠ ng∆∞·ªùi thu√™)"]:::renter
            ESC["Escrow Balance<br />(Gi·ªØ t·∫°m)"]:::escrow
            REV["Revenue Balance<br />(Platform 10%)"]:::platform
            PP["PendingPayout<br />(Lender 90%)"]:::lender
            LB["Lender Balance<br />(V√≠ ch·ªß s√°ch)"]:::lender

            RB -->|"pay-wallet<br />price = book.price"| ESC
            ESC -->|"confirm-return<br />platformFee = price √ó 10%"| REV
            ESC -->|"confirm-return<br />lenderAmount = price √ó 90%"| PP
            PP -->|"Admin payout<br />/api/admin/payout"| LB
        </div>
    </div>



    <!-- 17. Blockchain Sync Flow (from EXTRACTED_LOGIC.md) -->
    <div class="diagram-container">
        <h2>17. Lu·ªìng Blockchain Sync & SBT Evidence (v3.0)</h2>
        <p class="description">Th·ª© t·ª± mint SBT v√† l∆∞u Evidence on-chain sau khi fix CF-1. Ngu·ªìn: EXTRACTED_LOGIC.md +
            B√ÅO_C√ÅO_PH√ÇN_T√çCH_V3.md.</p>
        <div class="mermaid">
            sequenceDiagram
            autonumber

            participant User as Renter
            participant BE as Backend
            participant SBT as RentalAgreementSBT
            participant Vault as VinaLibVault
            participant Book as BookAsset

            rect rgb(240, 248, 255)
            Note over User,Book: B∆∞·ªõc 1: K√Ω h·ª£p ƒë·ªìng (Contract Accept)
            User->>BE: POST /contracts/:id/accept
            BE->>BE: PolicyEngine.decide()
            alt AUTO
            BE->>SBT: safeMint(renter, termsHash)
            SBT-->>BE: SBT ID #1
            BE->>BE: booking.rentalSBTId = #1
            BE-->>User: SIGNED_UNPAID
            else MANUAL/REVIEW
            BE-->>User: SIGNED_PENDING_APPROVAL
            Note over BE: Admin approve ‚Üí mint SBT t∆∞∆°ng t·ª±
            end
            end

            rect rgb(240, 255, 240)
            Note over User,Book: B∆∞·ªõc 2: Thanh to√°n (Payment Sync)
            User->>BE: POST /booking/:code/pay-wallet
            BE->>BE: Tr·ª´ balance ‚Üí Escrow
            BE->>Vault: createRental(..., existingSbtId=#1)
            activate Vault
            Vault->>Vault: L∆∞u EvidencePack
            Vault->>Vault: rentalToSBT[bookId] = #1
            Vault->>Book: verifyPreRent + setUser
            Vault-->>BE: Event: RentalCreated
            deactivate Vault
            BE-->>User: PAID + txHash
            end

            rect rgb(255, 240, 245)
            Note over User,Book: B∆∞·ªõc 3: Tr·∫£ s√°ch
            User->>BE: return-request
            BE->>Vault: requestReturn(bookId, deliveryHash)
            Note over Vault: checkUpkeep() ph√°t hi·ªán ReturnRequested
            BE->>Vault: confirmReturn(bookId, isDamaged)
            Vault->>Book: verifyReturn(isDamaged)
            Vault-->>BE: Event: RentalConcluded
            BE->>BE: Settlement Escrow
            BE-->>User: COMPLETED
            end
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>

</html>
